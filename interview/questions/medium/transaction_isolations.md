# Транзакции и обеспечение безопасности и параллельности в них

## Условие
Транзакции — это действия (CRUD-операции), которые происходят при обращении к базе данных в рамках одного метода или клиента. Они представляют собой группу операций в БД, которые должны выполняться согласованно.

При выполнении транзакций возникают следующие вопросы:
- Какой будет результат, если одновременно выполняется несколько запросов?
- Увидит ли одна транзакция изменения другой параллельно выполняемой транзакции?

## Решение

Для решения этих вопросов были сформированы 4 принципа ACID:

### ACID — 4 свойства транзакций
- **Atomicity (атомарность)** — гарантирует, что все операции транзакции выполнятся либо полностью, либо не выполнятся вовсе (в случае ошибки — откат rollback).
- **Consistency (согласованность)** — гарантирует, что данные останутся согласованными после выполнения транзакции.
- **Isolation (изолированность)** — обеспечивает независимость транзакций друг от друга.
- **Durability (устойчивость)** — гарантирует, что зафиксированные изменения сохранятся даже в случае сбоя системы.

Для обеспечения безопасности параллельного выполнения транзакций используются **уровни изоляции**:

### Уровни изоляции транзакций
- **SERIALIZABLE**
- **REPEATABLE_READ**
- **READ_COMMITTED**
- **READ_UNCOMMITTED**

#### 1. SERIALIZABLE
Этот уровень обеспечивает максимальную изоляцию: транзакции выполняются последовательно, а не параллельно. Изменения в одной транзакции становятся видимыми только после её завершения.

**Плюсы:**
- Строгая согласованность данных.
- Исключает аномалии конкурентного доступа.

**Минусы:**
- Высокая задержка из-за блокировок.
- Возможны взаимные блокировки (deadlocks).
- Несовместим с другими типами транзакций

#### 2. READ_COMMITTED
Позволяет транзакциям видеть только зафиксированные (committed) изменения других транзакций. Однако возможно явление неповторяющегося чтения (non-repeatable read).

**Пример:**
```
Первая транзакция проверяет баланс 1000 ₽ и решает уменьшить его на 100 ₽.
В это время вторая транзакция уменьшает баланс до 0 ₽ и фиксирует изменения.
Первая транзакция продолжает своё выполнение и уходит в минус.
```

**Плюсы:**
- Хорош для чтения обновлённых данных.
- Быстрее за счёт меньшего числа блокировок.

**Минусы:**
- Возможны изменения одной записи несколькими транзакциями одновременно.

#### 3. REPEATABLE_READ
Этот уровень фиксирует состояние базы на момент начала транзакции. Все запросы в её рамках работают с этим снимком данных, исключая неповторяющееся чтение. Однако возможно фантомное чтение (phantom read).

**Разница между фантомным и неповторяющимся чтением:**
- **Неповторяющееся чтение:** одни и те же строки изменяются между запросами.
- **Фантомное чтение:** изменяется набор строк, участвующих в запросе.

**Пример:**
```
Пользователь A выполняет запрос дважды.
В промежутке пользователь B изменяет данные и фиксирует транзакцию.
- В неповторяющемся чтении: строка, полученная A, меняет значение.
- В фантомном чтении: изменяется сам набор возвращаемых строк.
```

#### 4. READ_UNCOMMITTED
На этом уровне изолированности видны все изменения параллельных транзакицй, даже незакомиченных

**Плюсы:**
- Самый быстрый тип транзакции

**Минусы:**
- Не гарантирует согласованности данных
- Не обеспечивает изолированности данных
- Возможно неповторяющееся и фантомное чтение
- Возможны изменения одной записи несколькими транзакциями одновременно

## Ссылки на используемые материалы
1. [Уровни изоляции транзакций в PostgreSQL](https://habr.com/ru/articles/317884/)
2. [Уровни изоляции транзакций](https://postgrespro.ru/docs/postgrespro/9.5/transaction-iso)
3. [Уровни изоляции транзакций 2](https://habr.com/ru/companies/postgrespro/articles/442804/)

